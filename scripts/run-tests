#!/usr/bin/env bash
# NAME
#     run-tests - run the full test matrix (frontend unit, unit, property, integration, e2e)
# SYNOPSIS
#     scripts/run-tests [--skip-frontend] [--skip-property] [--skip-integration] [--skip-e2e]
# DESCRIPTION
#     Runs Vitest frontend unit tests, pytest suites for unit/property/integration, and Cypress e2e while
#     timing each suite, hiding verbose logs when everything passes, and spilling temp log
#     paths if something fails.

set -euo pipefail

readonly REPO_NAME="dojo"
readonly SCRIPT_NAME="run-tests"
readonly TMP_DIR="${TMPDIR:-/tmp}"
RUN_DIR=$(mktemp -d "${TMP_DIR}/${REPO_NAME}-${SCRIPT_NAME}-XXXXXX")
readonly RUN_DIR

SKIP_FRONTEND=0
SKIP_PROPERTY=0
SKIP_INTEGRATION=0
SKIP_E2E=0
COVERAGE=0
PYTHON_COVERAGE_RAN=0
E2E_COVERAGE_RAN=0
readonly COVERAGE_DIR="coverage"

declare -A FILTERS_PATTERN=()
FILTERED=0

usage() {
    cat <<EOF
NAME
    ${SCRIPT_NAME} - run frontend unit, pytest suites, and Cypress e2e with unified reporting
SYNOPSIS
    scripts/${SCRIPT_NAME} [--skip-frontend] [--skip-property] [--skip-integration] [--skip-e2e] [--filter SUITE[:PATTERN]] [--coverage] [-h|--help]
DESCRIPTION
    Runs frontend unit tests (Vitest), Python unit/property/integration suites, and e2e tests (Cypress with Chrome),
    printing a terse [OK]/[FAIL] summary per suite. Failures reference a temp log for the full output.
    Use --filter to target a single suite (e.g., --filter frontend or --filter e2e:01-payday-assignment). Pass --coverage
    to enable pytest-cov instrumentation + Cypress code coverage artifacts under coverage/.
EOF
}

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                usage
                exit 0
                ;;
            --skip-frontend)
                SKIP_FRONTEND=1
                shift
                ;;
            --skip-property)
                SKIP_PROPERTY=1
                shift
                ;;
            --skip-integration)
                SKIP_INTEGRATION=1
                shift
                ;;
            --skip-e2e)
                SKIP_E2E=1
                shift
                ;;
            --filter)
                shift
                if [[ $# -eq 0 ]]; then
                    echo "--filter requires an argument" >&2
                    usage
                    exit 1
                fi
                add_filter "$1"
                shift
                ;;
            --filter=*)
                add_filter "${1#*=}"
                shift
                ;;
            --coverage)
                COVERAGE=1
                shift
                ;;
            *)
                echo "Unknown option: $1" >&2
                usage
                exit 1
                ;;
        esac
    done
}

add_filter() {
    local raw="$1"
    local suite pattern
    if [[ "$raw" == *:* ]]; then
        suite="${raw%%:*}"
        pattern="${raw#*:}"
    else
        suite="$raw"
        pattern=""
    fi
    suite="$(printf '%s' "$suite" | tr '[:upper:]' '[:lower:]')"
    case "$suite" in
        frontend|unit|property|integration|e2e)
            ;;
        *)
            echo "Invalid filter suite: $suite" >&2
            exit 1
            ;;
    esac
    FILTERS_PATTERN["$suite"]="$pattern"
    FILTERED=1
}

should_run_suite() {
    local suite="$1"
    if [[ "$FILTERED" -eq 0 ]]; then
        return 0
    fi
    [[ -n "${FILTERS_PATTERN[$suite]+x}" ]]
}

suite_pattern() {
    local suite="$1"
    if [[ -n "${FILTERS_PATTERN[$suite]+x}" ]]; then
        printf '%s' "${FILTERS_PATTERN[$suite]}"
    fi
    return 0
}

sanitize_label() {
    local label="$1"
    local sanitized
    sanitized=$(printf '%s' "$label" | tr '[:upper:]' '[:lower:]' | tr -c '[:alnum:]' '-')
    while [[ "$sanitized" == *--* ]]; do
        sanitized="${sanitized//--/-}"
    done
    sanitized="${sanitized#-}"
    sanitized="${sanitized%-}"
    if [[ -z "$sanitized" ]]; then
        sanitized="suite"
    fi
    printf '%s' "$sanitized"
}

time_diff() {
    python - "$1" "$2" <<'PY'
import sys
start = float(sys.argv[1])
end = float(sys.argv[2])
print(f"{end - start:.2f}")
PY
}

log_stats() {
    local file="$1"
    local lines bytes
    lines=$(wc -l <"$file" | tr -d '[:space:]')
    bytes=$(stat -c%s "$file")
    printf '%s %s' "$lines" "$bytes"
}

had_failure=0

run_suite() {
    local label="$1"
    shift
    local suite_id
    suite_id=$(sanitize_label "$label")
    local log
    log="${RUN_DIR}/${suite_id}.log"
    local start end elapsed
    start=$(date +%s.%N)

    if "$@" >"$log" 2>&1; then
        end=$(date +%s.%N)
        elapsed=$(time_diff "$start" "$end")
        rm -f "$log"
        echo "[OK]   $label in ${elapsed}s"
        return 0
    else
        end=$(date +%s.%N)
        elapsed=$(time_diff "$start" "$end")
        local stats lines bytes log_name
        stats=$(log_stats "$log")
        lines=${stats%% *}
        bytes=${stats##* }
        log_name=$(basename "$log")
        echo "[FAIL] $label failed in ${elapsed}s see ${log_name}{lines: ${lines}, bytes: ${bytes}}"
        had_failure=1
        return 1
    fi
}


parse_args "$@"

if [[ "$COVERAGE" -eq 1 ]]; then
    rm -rf "$COVERAGE_DIR"
    rm -rf .nyc_output
    mkdir -p "$COVERAGE_DIR"
fi

pids=()
if [[ "$SKIP_FRONTEND" -eq 1 ]]; then
    echo "[SKIP] frontend tests (--skip-frontend)"
elif should_run_suite frontend; then
    frontend_cmd=(npm run test:unit --prefix src/dojo/frontend/vite)
    frontend_pattern=$(suite_pattern frontend)
    if [[ -n "$frontend_pattern" ]]; then
        frontend_cmd+=(-- --testNamePattern "$frontend_pattern")
    fi
    run_suite "frontend unit tests" "${frontend_cmd[@]}" &
    pids+=($!)
else
    echo "[SKIP] frontend tests (filtered)"
fi

if should_run_suite unit; then
    if [[ "$COVERAGE" -eq 1 ]]; then
        unit_cmd=(env COVERAGE_FILE="${COVERAGE_DIR}/.coverage.unit" python -m pytest --cov=src/dojo --cov-config=.coveragerc --cov-report=term-missing:skip-covered tests/unit)
        PYTHON_COVERAGE_RAN=1
    else
        unit_cmd=(python -m pytest tests/unit)
    fi
    unit_pattern=$(suite_pattern unit)
    if [[ -n "$unit_pattern" ]]; then
        unit_cmd+=(-k "$unit_pattern")
    fi
    run_suite "unit tests" "${unit_cmd[@]}" &
    pids+=($!)
else
    echo "[SKIP] unit tests (filtered)"
fi

if [[ "$SKIP_PROPERTY" -eq 1 ]]; then
    echo "[SKIP] property tests (--skip-property)"
elif should_run_suite property; then
    if [[ "$COVERAGE" -eq 1 ]]; then
        prop_cmd=(env COVERAGE_FILE="${COVERAGE_DIR}/.coverage.property" python -m pytest --cov=src/dojo --cov-config=.coveragerc --cov-report=term-missing:skip-covered tests/property)
        PYTHON_COVERAGE_RAN=1
    else
        prop_cmd=(python -m pytest tests/property)
    fi
    prop_pattern=$(suite_pattern property)
    if [[ -n "$prop_pattern" ]]; then
        prop_cmd+=(-k "$prop_pattern")
    fi
    run_suite "property tests" "${prop_cmd[@]}" &
    pids+=($!)
else
    echo "[SKIP] property tests (filtered)"
fi

if [[ "$SKIP_INTEGRATION" -eq 1 ]]; then
    echo "[SKIP] integration tests (--skip-integration)"
elif [[ ! -d tests/integration ]]; then
    echo "[SKIP] integration tests (tests/integration missing)"
elif should_run_suite integration; then
    if [[ "$COVERAGE" -eq 1 ]]; then
        int_cmd=(env COVERAGE_FILE="${COVERAGE_DIR}/.coverage.integration" python -m pytest --cov=src/dojo --cov-config=.coveragerc --cov-report=term-missing:skip-covered tests/integration)
        PYTHON_COVERAGE_RAN=1
    else
        int_cmd=(python -m pytest tests/integration)
    fi
    int_pattern=$(suite_pattern integration)
    if [[ -n "$int_pattern" ]]; then
        int_cmd+=(-k "$int_pattern")
    fi
    run_suite "integration tests" "${int_cmd[@]}" &
    pids+=($!)
else
    echo "[SKIP] integration tests (filtered)"
fi

if [[ "$SKIP_E2E" -eq 1 ]]; then
    echo "[SKIP] e2e tests (--skip-e2e)"
elif should_run_suite e2e; then
    if [[ "$COVERAGE" -eq 1 ]]; then
        e2e_cmd=(env CYPRESS_COVERAGE=1 npx --prefix src/dojo/frontend/vite cypress run --e2e --browser chrome)
        E2E_COVERAGE_RAN=1
    else
        e2e_cmd=(npx --prefix src/dojo/frontend/vite cypress run --e2e --browser chrome)
    fi
    e2e_pattern=$(suite_pattern e2e)
    if [[ -n "$e2e_pattern" ]]; then
        if [[ "$e2e_pattern" == */* ]]; then
            spec="$e2e_pattern"
        else
            spec="cypress/e2e/user-stories/${e2e_pattern}.cy.js"
        fi
        if [[ ! -f "$spec" ]]; then
            echo "[FAIL] e2e spec not found: $spec" >&2
            exit 1
        fi
        e2e_cmd+=(--spec "$spec")
    fi
    run_suite "e2e tests (cypress)" "${e2e_cmd[@]}" &
    pids+=($!)
else
    echo "[SKIP] e2e tests (filtered)"
fi

for pid in "${pids[@]}"; do
    if ! wait "$pid"; then
        had_failure=1
    fi
done

if [[ "$COVERAGE" -eq 1 ]]; then
    if [[ "$PYTHON_COVERAGE_RAN" -eq 1 ]]; then
        if ls "${COVERAGE_DIR}"/.coverage.* >/dev/null 2>&1; then
            if python -m coverage combine "$COVERAGE_DIR" >/dev/null 2>&1; then
                python -m coverage xml -o "${COVERAGE_DIR}/coverage.xml" >/dev/null
                python -m coverage json -o "${COVERAGE_DIR}/coverage.json" >/dev/null
                echo "[OK] python coverage artifacts written to ${COVERAGE_DIR}/coverage.xml"
            else
                echo "[WARN] failed to combine python coverage data" >&2
            fi
        else
            echo "[WARN] coverage enabled but no python suites produced data" >&2
        fi
    fi
    if [[ "$E2E_COVERAGE_RAN" -eq 1 ]]; then
        if [[ -d .nyc_output ]] && ls .nyc_output/* >/dev/null 2>&1; then
            if npx --prefix src/dojo/frontend/vite c8 report --clean false --temp-directory .nyc_output --reporter=lcov --reports-dir "$COVERAGE_DIR" >/dev/null 2>&1; then
                echo "[OK] cypress coverage artifacts written to ${COVERAGE_DIR}/lcov.info"
            else
                echo "[WARN] failed to write cypress coverage report" >&2
            fi
        else
            echo "[WARN] coverage enabled but no Cypress coverage data found" >&2
        fi
    fi
fi

if [[ "$had_failure" -ne 0 ]]; then
    echo "[FAIL] ${SCRIPT_NAME} (one or more suites failed) log dir: ${RUN_DIR}"
    exit 1
fi

echo "[OK] ${SCRIPT_NAME} (all requested suites passed)"
exit 0
