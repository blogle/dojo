#!/usr/bin/env bash
# NAME
#     run-tests - run the full test matrix (unit, property, integration, e2e)
# SYNOPSIS
#     scripts/run-tests [--skip-property] [--skip-integration] [--skip-e2e]
# DESCRIPTION
#     Runs pytest suites for unit, property, and integration code plus Cypress e2e while
#     timing each suite, hiding verbose logs when everything passes, and spilling temp log
#     paths if something fails.

set -euo pipefail

readonly REPO_NAME="dojo"
readonly SCRIPT_NAME="run-tests"
readonly TMP_DIR="${TMPDIR:-/tmp}"
RUN_DIR=$(mktemp -d "${TMP_DIR}/${REPO_NAME}-${SCRIPT_NAME}-XXXXXX")
readonly RUN_DIR

SKIP_PROPERTY=0
SKIP_INTEGRATION=0
SKIP_E2E=0

declare -A FILTERS_PATTERN=()
FILTERED=0

usage() {
    cat <<EOF
NAME
    ${SCRIPT_NAME} - run pytest suites and Cypress e2e with unified reporting
SYNOPSIS
    scripts/${SCRIPT_NAME} [--skip-property] [--skip-integration] [--skip-e2e] [--filter SUITE[:PATTERN]] [-h|--help]
DESCRIPTION
    Runs unit, property, integration, and e2e suites (Cypress with Chrome) and prints a
    terse [OK]/[FAIL] summary per suite. Failures reference a temp log for the full output.
    Use --filter to target a single suite (e.g., --filter unit:budgeting or --filter e2e:01-payday-assignment).
EOF
}

parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                usage
                exit 0
                ;;
            --skip-property)
                SKIP_PROPERTY=1
                shift
                ;;
            --skip-integration)
                SKIP_INTEGRATION=1
                shift
                ;;
            --skip-e2e)
                SKIP_E2E=1
                shift
                ;;
            --filter)
                shift
                if [[ $# -eq 0 ]]; then
                    echo "--filter requires an argument" >&2
                    usage
                    exit 1
                fi
                add_filter "$1"
                shift
                ;;
            --filter=*)
                add_filter "${1#*=}"
                shift
                ;;
            *)
                echo "Unknown option: $1" >&2
                usage
                exit 1
                ;;
        esac
    done
}

add_filter() {
    local raw="$1"
    local suite pattern
    if [[ "$raw" == *:* ]]; then
        suite="${raw%%:*}"
        pattern="${raw#*:}"
    else
        suite="$raw"
        pattern=""
    fi
    suite="$(printf '%s' "$suite" | tr '[:upper:]' '[:lower:]')"
    case "$suite" in
        unit|property|integration|e2e)
            ;;
        *)
            echo "Invalid filter suite: $suite" >&2
            exit 1
            ;;
    esac
    FILTERS_PATTERN["$suite"]="$pattern"
    FILTERED=1
}

should_run_suite() {
    local suite="$1"
    if [[ "$FILTERED" -eq 0 ]]; then
        return 0
    fi
    [[ -n "${FILTERS_PATTERN[$suite]+x}" ]]
}

suite_pattern() {
    local suite="$1"
    if [[ -n "${FILTERS_PATTERN[$suite]+x}" ]]; then
        printf '%s' "${FILTERS_PATTERN[$suite]}"
    fi
    return 0
}

sanitize_label() {
    local label="$1"
    local sanitized
    sanitized=$(printf '%s' "$label" | tr '[:upper:]' '[:lower:]' | tr -c '[:alnum:]' '-')
    while [[ "$sanitized" == *--* ]]; do
        sanitized="${sanitized//--/-}"
    done
    sanitized="${sanitized#-}"
    sanitized="${sanitized%-}"
    if [[ -z "$sanitized" ]]; then
        sanitized="suite"
    fi
    printf '%s' "$sanitized"
}

time_diff() {
    python - "$1" "$2" <<'PY'
import sys
start = float(sys.argv[1])
end = float(sys.argv[2])
print(f"{end - start:.2f}")
PY
}

log_stats() {
    local file="$1"
    local lines bytes
    lines=$(wc -l <"$file" | tr -d '[:space:]')
    bytes=$(stat -c%s "$file")
    printf '%s %s' "$lines" "$bytes"
}

had_failure=0

run_suite() {
    local label="$1"
    shift
    local suite_id
    suite_id=$(sanitize_label "$label")
    local log
    log="${RUN_DIR}/${suite_id}.log"
    local start end elapsed
    start=$(date +%s.%N)

    if "$@" >"$log" 2>&1; then
        end=$(date +%s.%N)
        elapsed=$(time_diff "$start" "$end")
        rm -f "$log"
        echo "[OK]   $label in ${elapsed}s"
        return 0
    else
        end=$(date +%s.%N)
        elapsed=$(time_diff "$start" "$end")
        local stats lines bytes log_name
        stats=$(log_stats "$log")
        lines=${stats%% *}
        bytes=${stats##* }
        log_name=$(basename "$log")
        echo "[FAIL] $label failed in ${elapsed}s see ${log_name}{lines: ${lines}, bytes: ${bytes}}"
        had_failure=1
        return 1
    fi
}


parse_args "$@"

pids=()
if should_run_suite unit; then
    unit_cmd=(python -m pytest tests/unit)
    unit_pattern=$(suite_pattern unit)
    if [[ -n "$unit_pattern" ]]; then
        unit_cmd+=(-k "$unit_pattern")
    fi
    run_suite "unit tests" "${unit_cmd[@]}" &
    pids+=($!)
else
    echo "[SKIP] unit tests (filtered)"
fi

if [[ "$SKIP_PROPERTY" -eq 1 ]]; then
    echo "[SKIP] property tests (--skip-property)"
elif should_run_suite property; then
    prop_cmd=(python -m pytest tests/property)
    prop_pattern=$(suite_pattern property)
    if [[ -n "$prop_pattern" ]]; then
        prop_cmd+=(-k "$prop_pattern")
    fi
    run_suite "property tests" "${prop_cmd[@]}" &
    pids+=($!)
else
    echo "[SKIP] property tests (filtered)"
fi

if [[ "$SKIP_INTEGRATION" -eq 1 ]]; then
    echo "[SKIP] integration tests (--skip-integration)"
elif [[ ! -d tests/integration ]]; then
    echo "[SKIP] integration tests (tests/integration missing)"
elif should_run_suite integration; then
    int_cmd=(python -m pytest tests/integration)
    int_pattern=$(suite_pattern integration)
    if [[ -n "$int_pattern" ]]; then
        int_cmd+=(-k "$int_pattern")
    fi
    run_suite "integration tests" "${int_cmd[@]}" &
    pids+=($!)
else
    echo "[SKIP] integration tests (filtered)"
fi

if [[ "$SKIP_E2E" -eq 1 ]]; then
    echo "[SKIP] e2e tests (--skip-e2e)"
elif should_run_suite e2e; then
    e2e_cmd=(npx cypress run --e2e --browser chrome)
    e2e_pattern=$(suite_pattern e2e)
    if [[ -n "$e2e_pattern" ]]; then
        if [[ "$e2e_pattern" == */* ]]; then
            spec="$e2e_pattern"
        else
            spec="cypress/e2e/user-stories/${e2e_pattern}.cy.js"
        fi
        if [[ ! -f "$spec" ]]; then
            echo "[FAIL] e2e spec not found: $spec" >&2
            exit 1
        fi
        e2e_cmd+=(--spec "$spec")
    fi
    run_suite "e2e tests (cypress)" "${e2e_cmd[@]}" &
    pids+=($!)
else
    echo "[SKIP] e2e tests (filtered)"
fi

for pid in "${pids[@]}"; do
    if ! wait "$pid"; then
        had_failure=1
    fi
done

if [[ "$had_failure" -ne 0 ]]; then
    echo "[FAIL] ${SCRIPT_NAME} (one or more suites failed) log dir: ${RUN_DIR}"
    exit 1
fi

echo "[OK] ${SCRIPT_NAME} (all requested suites passed)"
exit 0
